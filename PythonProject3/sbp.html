<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Оплата через СБП</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
  <header>
    <h1>Оплата через СБП (Tinkoff)</h1>
    <p>Отсканируйте QR-код или оплатите через приложение банка</p>
  </header>

  <div class="tariff-card" style="max-width:400px;margin:auto;">
    <p id="uc"></p>
    <p id="amount"></p>
    <div id="qr"></div>
    <button id="open-bank" style="display:none;">Открыть в банке</button>
    <p id="status"></p>
  </div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const amount = params.get('amount') || 0;
const uc = params.get('uc') || 0;

document.getElementById('amount').textContent = `Сумма: ${amount} $`;
document.getElementById('uc').textContent = `Пакет: ${uc} UC`;

async function createPayment() {
  const res = await fetch('/api/create-payment', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ amount })
  });
  const data = await res.json();
  const qrData = data.qrData;

  document.getElementById('qr').innerHTML =
    `<img src="https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=${encodeURIComponent(qrData)}" alt="QR">`;
  document.getElementById('open-bank').style.display = 'inline-block';
  document.getElementById('open-bank').onclick = () => window.location.href = data.payUrl;

  pollStatus(data.paymentId);
}

async function pollStatus(id) {
  const statusEl = document.getElementById('status');
  const interval = setInterval(async () => {
    const res = await fetch('/api/check-payment/' + id);
    const status = (await res.json()).status;
    statusEl.textContent = 'Статус: ' + status;
    if (status === 'CONFIRMED') {
      clearInterval(interval);
      alert('✅ Оплата подтверждена!');
      window.location.href = 'index.html';
    }
  }, 4000);
}

createPayment();
</script>
</body>
</html>
